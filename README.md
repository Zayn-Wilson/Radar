# RoboMaster 雷达系统

这个项目是为RoboMaster大学生机器人竞赛开发的雷达站系统。通过计算机视觉技术，本系统能够实时识别场上的机器人位置，并通过串口将坐标发送给裁判系统，实现战场态势感知。

## 功能概述

- **机器人识别**：使用YOLOv5检测战场上的机器人和装甲板
- **坐标映射**：将2D图像坐标通过仿射变换映射到比赛地图上
- **坐标滤波**：使用滑动窗口均值滤波优化机器人位置坐标
- **盲区预测**：当机器人进入视野盲区时，进行位置预测
- **双倍易伤系统**：支持飞镖双倍易伤判定和请求
- **可视化界面**：显示战场态势和关键比赛信息

## 系统架构

系统由以下几个主要部分组成：
1. 图像采集模块（支持海康相机或USB相机）
2. 目标检测模块（两级检测：机器人→装甲板）
3. 坐标转换和滤波模块
4. 串口通信模块
5. 用户界面模块

## 文件结构

```
├── main.py                      # 主程序
├── detect_function.py           # YOLOv5检测器
├── diagnostic.py                # 系统诊断工具
├── information_ui.py            # 信息UI绘制函数
├── hik_camera.py                # 海康相机接口
├── RM_serial_py/                # 裁判系统通信
│   └── ser_api.py               # 串口通信API
├── MvImport/                    # Windows版海康相机SDK
├── MvImport_Linux/              # Linux版海康相机SDK
├── models/                      # 深度学习模型
│   ├── car.onnx                 # 机器人检测模型
│   └── armor.onnx               # 装甲板检测模型
├── yaml/                        # 模型配置
│   ├── car.yaml                 # 机器人检测配置
│   └── armor.yaml               # 装甲板检测配置
└── images/                      # 图像资源
    ├── map.jpg                  # 通用地图
    ├── map_red.jpg              # 红方视角地图
    ├── map_blue.jpg             # 蓝方视角地图
    └── map_mask.jpg             # 地图掩码图像
```

## 硬件要求

- **相机**：海康工业相机（推荐）或USB摄像头
- **计算平台**：支持CUDA的NVIDIA GPU（推荐用于实时性能）
- **串口**：连接裁判系统的串口（通常为USB转TTL串口）

## 软件依赖

- Python 3.8+
- PyTorch 1.7+
- OpenCV 4.5+
- NumPy
- PySerial
- 海康相机SDK（如果使用海康相机）

## 安装指南

1. 克隆本仓库：
   ```bash
   git clone https://github.com/yourusername/rmuc-radar-system.git
   cd rmuc-radar-system
   ```

2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

3. 安装海康相机SDK（如果使用海康相机）：
   - Windows系统：运行MvImport目录下的安装程序
   - Linux系统：按照MvImport_Linux目录中的说明安装

## 使用方法

1. 连接相机和裁判系统串口

2. 设置配置参数（在main.py中）：
   - 选择阵营：`state = 'R'` 红方或 `state = 'B'` 蓝方
   - 选择相机模式：`camera_mode = 'hik'` 海康相机，`camera_mode = 'video'` USB相机，或 `camera_mode = 'test'` 测试模式
   - 设置串口：`ser1 = serial.Serial('/dev/ttyUSB0', 115200, timeout=1)` 根据实际串口修改

3. 运行程序：
   ```bash
   python main.py
   ```

## 工作原理

1. **双级目标检测**：
   - 第一级检测识别场上所有机器人
   - 第二级检测在每个机器人区域内识别装甲板

2. **坐标映射**：
   - 使用预先标定的仿射变换矩阵，将图像坐标映射到实际地图坐标
   - 支持多高度层的坐标映射（地面层、R型高地、环形高地）

3. **坐标滤波**：
   - 使用滑动窗口均值滤波，减少坐标抖动
   - 异常值检测，防止坐标突变

4. **盲区预测**：
   - 当机器人不在视野内时，系统会基于预设的点位和历史数据进行位置预测
   - 预测点会根据标记进度动态调整

5. **串口通信**：
   - 按照RoboMaster裁判系统协议打包数据
   - 支持接收标记进度、双倍易伤状态等信息

## 性能优化

- **模型转换**：建议将ONNX模型转换为TensorRT的engine模型，推理速度可提升约10倍
- **参数调整**：
  - 检测置信度阈值（conf_thres）可根据现场光照条件调整
  - 滤波窗口大小（window_size）可根据画面稳定性调整

## 常见问题

1. **相机连接失败**：
   - 检查相机权限和驱动安装
   - 海康相机需要安装MVS驱动

2. **检测精度不佳**：
   - 调整相机曝光时间和增益
   - 检查场地光照条件

3. **坐标映射不准**：
   - 重新标定仿射变换矩阵
   - 确认使用了正确的阵营地图

4. **串口通信失败**：
   - 检查串口权限和连接状态
   - 验证波特率设置（115200）

## 注意事项

1. 系统需要预先标定仿射变换矩阵（arrays_test_red.npy和arrays_test_blue.npy）
2. 运行程序前确保海康相机驱动已正确安装
3. 建议比赛前进行完整的系统测试，包括识别准确性和通信稳定性

## 维护与支持

如有问题或需要帮助，请联系项目维护者或提交Issue。
